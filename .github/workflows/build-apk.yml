name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Create minimal package.json for build
      run: |
        cat > package.json << 'PKG'
        {
          "name": "txghzs-build",
          "version": "1.0.0",
          "scripts": {
            "build": "vite build"
          },
          "dependencies": {
            "vue": "^3.5.25",
            "vue-router": "^4.6.4",
            "pinia": "^3.0.4",
            "axios": "^1.13.5",
            "dayjs": "^1.11.19",
            "vant": "^4.9.22"
          },
          "devDependencies": {
            "@vitejs/plugin-vue": "^6.0.4",
            "vite": "^7.3.1",
            "terser": "^5.46.0",
            "unplugin-auto-import": "^21.0.0",
            "unplugin-vue-components": "^31.0.0",
            "@vant/auto-import-resolver": "^1.3.0"
          }
        }
        PKG
    
    - name: Create vite config
      run: |
        cat > vite.config.js << 'VITE'
        import { defineConfig } from 'vite'
        import vue from '@vitejs/plugin-vue'
        import AutoImport from 'unplugin-auto-import/vite'
        import Components from 'unplugin-vue-components/vite'
        import { VantResolver } from '@vant/auto-import-resolver'
        import { fileURLToPath, URL } from 'node:url'
        
        export default defineConfig({
          plugins: [
            vue(),
            AutoImport({ imports: ['vue', 'vue-router', 'pinia'], resolvers: [VantResolver()] }),
            Components({ resolvers: [VantResolver()] }),
          ],
          resolve: { alias: { '@': fileURLToPath(new URL('./src', import.meta.url)) } },
          build: { outDir: 'dist', minify: 'terser' }
        })
        VITE
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile=false
    
    - name: Build web app
      run: |
        pnpm build
        ls -la dist/
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Setup Capacitor and build APK
      run: |
        pnpm add @capacitor/core @capacitor/cli @capacitor/android
        npx cap init "退休规划助手" "com.txghzs.app" --web-dir dist || true
        npx cap add android || true
        npx cap copy android
        npx cap update android
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: txghzs-app-debug
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
